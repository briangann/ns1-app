{"version":3,"sources":["../../src/config/config.js"],"names":["configTemplate","Ns1ConfigCtrl","$scope","$injector","backendSrv","appModel","secureJsonData","jsonData","gnetTokenSet","ns1Token","error","appEditCtrl","setPreUpdateHook","preUpdate","bind","setPostUpdateHook","postUpdate","self","enabled","getCustomerId","then","resp","gnet_token","initDatasource","Promise","resolve","importDashboards","console","log","get","results","foundGraphite","foundElastic","_","forEach","ds","name","promises","graphite","type","url","access","push","post","elastic","database","esVersion","interval","timeField","all","template"],"mappings":"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","file":"config.js","sourcesContent":["import configTemplate from './config.html!text';\n\nclass Ns1ConfigCtrl {\n  constructor($scope, $injector, backendSrv) {\n    this.backendSrv = backendSrv;\n    this.appModel.secureJsonData = {};\n    if (this.appModel.jsonData === null) {\n      this.appModel.jsonData = {\n        gnetTokenSet: false,\n        ns1Token: null,\n      };\n    }\n    this.error = false;\n    this.appEditCtrl.setPreUpdateHook(this.preUpdate.bind(this));\n    this.appEditCtrl.setPostUpdateHook(this.postUpdate.bind(this));\n    var self = this;\n    if (this.appModel.enabled) {\n      this.getCustomerId().then((resp) => {}, () => {\n        // if we cant get the customerId, then we need to re-enter the ns1Token.\n        self.appModel.jsonData.ns1Token = null;\n        self.error = \"invalid NS1 apiKey. Please update the key.\";\n      });\n    }\n  }\n\n  preUpdate() {\n    if (this.appModel.secureJsonData.gnet_token) {\n      this.appModel.jsonData.gnetTokenSet = true;\n    }\n    return this.initDatasource();\n  }\n\n  postUpdate() {\n  \tvar self = this;\n    if (!this.appModel.enabled) {\n      return Promise.resolve();\n    }\n    // make sure our Api key works.\n    return this.getCustomerId()\n    .then((resp) => {\n      return this.appEditCtrl.importDashboards(); \n    }, () => {\n      console.log(\"failed to query NS1 API.\");\n    \tself.error = \"Unable to query NS1 API. please re-enter API Key\";\n      self.appModel.jsonData.ns1Token = null;\n    });\n  }\n\n  getCustomerId() {\n    return this.backendSrv.get(\"api/plugin-proxy/ns1-app/ns1/account/settings\");\n  }\n  \n  initDatasource() {\n    var self = this;\n    //check for existing datasource.\n    return self.backendSrv.get('api/datasources').then(function(results) {\n      var foundGraphite = false;\n      var foundElastic = false;\n      _.forEach(results, function(ds) {\n        if (foundGraphite && foundElastic) { return; }\n        if (ds.name === \"raintank\") {\n          foundGraphite = true;\n        }\n        if (ds.name === \"raintankEvents\") {\n          foundElastic = true;\n        }\n      });\n      var promises = [];\n      if (!foundGraphite) {\n        // create datasource.\n        var graphite = {\n          name: 'raintank',\n          type: 'graphite',\n          url: 'api/plugin-proxy/ns1-app/graphite',\n          access: 'direct',\n          jsonData: {}\n        };\n        promises.push(self.backendSrv.post('api/datasources', graphite));\n      }\n      if (!foundElastic) {\n        // create datasource.\n        var elastic = {\n          name: 'raintankEvents',\n          type: 'elasticsearch',\n          url: 'api/plugin-proxy/ns1-app/elasticsearch',\n          access: 'direct',\n          database: '[events-]YYYY-MM-DD',\n          jsonData: {\n            esVersion: 1,\n            interval: \"Daily\",\n            timeField: \"timestamp\"\n          }\n        };\n        promises.push(self.backendSrv.post('api/datasources', elastic));\n      }\n      return Promise.all(promises);\n    });\n  }\n}\n\nNs1ConfigCtrl.template = configTemplate;\n\nexport {\n  Ns1ConfigCtrl as ConfigCtrl\n};\n\n"]}